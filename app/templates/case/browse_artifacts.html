{% extends  "case/index.html" %}

{% block content %}


<!-- ===================== Dialog: artifact details ===================== -->

<div class="modal fade" id="record_details_dialog" role="dialog">
  <div class="modal-dialog modal-lg" style="width:70%;">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title"><i class="fa fa-cubes"></i> Artifacts Details</h4>
      </div>
      <div class="modal-body box-body"><table class="table table-condensed table_left_header" id="dialog_content"></table></div>
    </div>
  </div>
</div>

<!-- =============================== -->





<div id="content_body_row" >



<div id="content_table" class="col-xs-12" style="overflow-y: scroll;"><!--col-xs-12-->

<div class="box">



<div class="box-header no-padding">
<!-- ===================== Title ===================== -->

    <h3 class="box-title"> <i class="fa fa-cubes"></i> Artifacts </h3>
<!-- ===================== Search ===================== -->

    <div class="input-group">

            

        
        <select id="search_query" multiple data-role="tagsinput" class="form-control"></select>
        <input id="search_query_simple" />


        <!-- search buttons -->
        <div class="input-group-btn">

            
            <!-- reset button -->
            <button type="button" class="btn btn-primary btn-flat btn-sm" id="reset_search_terms" title="reset search terms" >
                <span class="fa fa-undo"></span>
            </button>

            <!-- simple search  -->
            <button type="button" class="btn btn-primary btn-flat btn-sm" id="simple_search_btn" title="enable/disable simple search" >
                <span class="fa fa-pencil"></span>
            </button>


            <!-- advanced search button -->
            <button type="button" class="btn btn-primary btn-flat btn-sm" id="advance_search_dialog_opener_btn" title="open advanced search">
                <span class="fa fa-gears"></span>
            </button>

            <button type="button" class="btn btn-primary btn-flat btn-sm" id="search_button"><i class="fa fa-search"></i></button>

            <!-- Save search as rule -->
            <button type="button" class="btn btn-primary btn-flat btn-sm" id="sample_search_confirm_rule" data-toggle="popover" data-original-title="Save search as rule"><i class="fa fa-save"></i></button>
            
                <div id="sample_search_confirm_popover" class="hide"   data-trigger="focus">



                  <div class="input-group input-group-sm">
                      <input type="text" class="form-control" placeholder="Rule name" id="sample_search_confirm_popover_rule_name">

                      <span class="input-group-btn">

                        <select class="form-control" id="sample_search_confirm_popover_rule_severity" style="width: 100px; height: 30px;">
                          <option selected="selected">Critical</option>
                          <option>High</option>
                          <option>Medium</option>
                          <option>Low</option>
                          <option>Whitelist</option>
                        </select>
                        <button type="button" class="btn btn-primary btn-flat sample_search_save_as_rule"><li class="fa  fa-check"></li></button>
                      </span>

                  </div>
                  <br />
                  <div>
                      <textarea class="form-control" id="sample_search_confirm_popover_rule_description" rows="3" placeholder="description ..." style="margin-bottom:10px;"></textarea>
                  </div>
                  
                </div>



        </div>

    </div>

</div>Raw Query: <a type="button" class="btn btn-transparent btn-xs details-arrow-toggle" data-target="sample_query_search"><i class="fa  fa-caret-down"></i></a>
<!-- =============================== -->



<!-- ===================== Advanced search ===================== -->
<div id="advance_search_dialog" style="display: none">
    <div class="box-body" style="padding-top: 0; padding-bottom: 0;">
        <div id="builder"></div>
        <div class="btn-group">
            <button type="button" class="btn btn-success btn-sm advanced_search_dialog_apply">Apply</button>
            <button type="button" class="btn btn-default btn-sm advanced_search_dialog_close">Close</button>
        </div>
    </div>
</div>
<!-- =============================== -->


<!-- ===================== Sample Query Box ===================== -->
    <div id="sample_query_search" style="display:none"></div>



<!-- =============================== -->
</div>

<!-- ===================== Artifacts table ===================== -->
        <div class="box">

        	<!-- START box Header -->
            
        	<div class="box-header">

            <div class="btn-group pull-left" id="artifacts_list_container">
                <a type="button" class="artifacts_list_button btn bg-blue btn-xs btn-flat dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" title="List artifacts types" > <i class="fa caret"></i></a>
                <a type="button" class="btn btn-default btn-xs" id="disable_enable_details_table" title="disable/enable record details"><i class="clickable fa fa-clone"></i></a>
                <ul id="artifacts_list" class="dropdown-menu artifacts-list-dropdown-toggle" role="menu"></ul>        
            </div>
            

            <span style="margin-left: 5px;">Total </span><span id="total_records" class="text-red"> </span>
             
            


                <div class="input-group float_right" style="width: 400px">
                  <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                  <input data="Data.@timestamp" type="text" class="form-control" id="query_pick_date_range" placeholder="yyyy-mm-dd HH:ii:ss,yyyy-mm-dd HH:ii:ss" autocomplete="off">
                </div>

            </div>

            <!-- END box Header -->


            <!-- table content  -->
            <div class="box-body no-padding" id="table_events_container" style="padding:10px">
              <table class="table table-bordered" id="table_events"><tbody ></tbody></table>
            </div>
        </div>

        <!-- ===================== paging box ===================== -->
        <div>
                    
            <div class="dataTables_info vertical-center pull-left"  >Number of pages <span class="label bg-yellow add_artifacts_machine_name_title"><span id="number_of_pages"></span></span></div>
            <div class="dataTables_paginate paging_simple_numbers pull-right"><ul class="pagination" id='paging'></ul></div>
        </div>
        <!-- =============================== -->
<!-- =============================== -->


        
        


  </div>
<!-- =============================== -->





<!-- ===================== Records details ===================== -->

<div id="record_details_block" class="col-md-4">
    <div class="box">
        <div class="box-header">
          <h3 class="box-title"><i class="fa fa-cubes"></i> Record Details</h3>
          <div class="box-tools pull-right">
                <button type="button" class="btn btn-box-tool" id="remove_record_details_block"><i class="fa fa-times"></i></button>
          </div>

          
        </div>
        <div class="box-body">
          <div id="record_details">  </div>
        </div>
    </div>
</div>


<!-- =============================== -->







<!-- jQuery 3 -->
<script src="../../static/bower_components/jquery/dist/jquery.min.js"></script>
<!-- Bootstrap 3.3.7 -->
<script src="../../static/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
<!-- DataTables -->
<script src="../../static/bower_components/datatables.net/js/jquery.dataTables.min.js"></script>
<script src="../../static/bower_components/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
<!-- SlimScroll -->
<script src="../../static/bower_components/jquery-slimscroll/jquery.slimscroll.min.js"></script>
<!-- FastClick -->
<script src="../../static/bower_components/fastclick/lib/fastclick.js"></script>
<!-- AdminLTE App -->
<script src="../../static/dist/js/adminlte.min.js"></script>
<!-- AdminLTE for demo purposes -->
<script src="../../static/dist/js/demo.js"></script>




<!-- Select2 -->
<script src="../../static/bower_components/select2/dist/js/select2.full.min.js"></script>

<!-- QueryBuilder -->
<link rel="stylesheet" href="{{url_for('static', filename='dist/jQuery-QueryBuilder/dist/css/query-builder.default.min.css')}}">
<script src="../../static/dist/jQuery-QueryBuilder/dist/js/query-builder.standalone.js"></script>


    <!-- popover -->
    <script src="../../static/bower_components/bootstrap/js/popover.js"></script>


    <!-- tag input -->

    <script src="../../static/dist/tagsinput/bootstrap-tagsinput.js"></script>
    <link rel="stylesheet" href="{{url_for('static', filename='dist/tagsinput/bootstrap-tagsinput.css')}}">
    <link rel="stylesheet" href="{{url_for('static', filename='dist/tagsinput/bootstrap-tagsinput-typeahead.css')}}">

    <!-- toast notifications -->
    <script src="../../static/dist/jquery_toast/jquery.toast.min.js"></script>
    <link rel="stylesheet" href="{{url_for('static', filename='dist/jquery_toast/jquery.toast.min.css')}}">



<script src="{{url_for('static' , filename='Kuiper.js')}}"></script>
<link rel="stylesheet" href="{{url_for('static' , filename='Kuiper.css')}}">




    <script src="../../static/dist/air-datepicker/dist/js/datepicker.min.js"></script>
    <link rel="stylesheet" href="{{url_for('static', filename='dist/air-datepicker/dist/css/datepicker.min.css')}}">
    <script src="../../static/dist/air-datepicker/dist/js/i18n/datepicker.en.js"></script>

<!-- This will take the AdminLTE input style and use it with the tags input style -->
<style type="text/css">
/* START ====== tagsinput */
.tag a {
    color: #fff;
}
.bootstrap-tagsinput {
    display:table-cell;
    z-index: 2;
    width: 100%;

    height: 32px;
    padding: 4px;
    border: 1px solid #393e5a;
    border-radius: 0px;
    background-color: #2a2d4b;
    
}

.div_focus{
    border: 1px solid #3c8dbc;
}

.bootstrap-tagsinput input{ 
    color: #e9e9e9;
}


.bootstrap-tagsinput[disabled] {
  background: #1e1d2f;
  cursor:default;
}
.bootstrap-tagsinput[disabled] input{
  visibility:hidden !important;
}
.bootstrap-tagsinput[disabled] > span > span{
  display:none !important;
}


/* END ====== tagsinput */

#search_query_simple{
    display:none;
    z-index: 2;
    width: 100%;

    height: 32px;
    padding: 4px;
    border: 1px solid #393e5a;
    border-radius: 0;
    color: #e9e9e9;
}
#search_query_simple:focus,
#search_query_simple:active{
    border: 1px solid #3c8dbc;
}

.float_right {
  float: right;
}
.jq-toast-single {
    font-size: 12px;
    width: fit-content;
    white-space: nowrap;
}
.jq-toast-single h2{
    font-size: 14px;
        font-weight: bold;

}
.clickable {
  cursor: pointer;
}


/* record details box style */
#record_details_block{
	padding: 0;
    table-layout: fixed;
    word-break: break-all;
    display: none;
    /*position: fixed;*/
    margin: 0;
}

#record_details{
    overflow-y: scroll;
}
#record_details::-webkit-scrollbar {
    width: 6px;
    background-color: #F5F5F5;
    margin: 0;
}
#record_details::-webkit-scrollbar-thumb {
    background-color: #b5bbc8;
}

/* content table style */
#content_table{
	padding: 0;
    table-layout: fixed;
    word-break: break-all;
    right: 0px;
}
#content_table::-webkit-scrollbar {
    width: 6px;
    background-color: #F5F5F5;
    margin: 0;
}
#content_table::-webkit-scrollbar-thumb {
    background-color: #b5bbc8;
}
/*******************************
* MODAL AS LEFT/RIGHT SIDEBAR
* Add "left" or "right" in modal parent div, after class="modal".
* Get free snippets on bootpen.com
*******************************/
  .modal.left .modal-dialog,
  .modal.right .modal-dialog {
    position: fixed;
    margin: auto;
    width: 40%;
    height: 100%;
    -webkit-transform: translate3d(0%, 0, 0);
        -ms-transform: translate3d(0%, 0, 0);
         -o-transform: translate3d(0%, 0, 0);
            transform: translate3d(0%, 0, 0);
  }

  .modal.left .modal-content,
  .modal.right .modal-content {
    height: 100%;
    overflow-y: auto;
  }

  .modal.left .modal-body,
  .modal.right .modal-body {
    padding: 15px 15px 80px;
  }


/*Right*/
  .modal.right.fade .modal-dialog {
    right: -320px;
    -webkit-transition: opacity 0.3s linear, right 0.3s ease-out;
       -moz-transition: opacity 0.3s linear, right 0.3s ease-out;
         -o-transition: opacity 0.3s linear, right 0.3s ease-out;
            transition: opacity 0.3s linear, right 0.3s ease-out;
  }

  .modal.right.fade.in .modal-dialog {
    right: 0;
  }

/* ----- MODAL STYLE ----- */
  .modal-content {
    border-radius: 0;
    border: none;
  }


  /* -------- Date picker ----------- */

/* ---------- Popover -----------*/
.popover {
  max-width: 400px;
  width:400px;
  right: 100px;
  left:0;
}
.popover-content {
  margin-right: 30px;
}
/* ---------------- search sample ---------------- */

#sample_search_confirm_rule{
}

#sample_query_search{
    /*height: 34px*/
    background-color: #292f42;
    border: 1px solid #393e5a;
    padding: 0 5px ;
}






.event_record_click>td>.popover {
    max-width: 150px;
    width:150px;
}

.event_record_click>td>.popover.right>.arrow:after {
    border-right-color: #393e5a;
}
.event_record_click>td>.popover.right>.popover-content {
  margin-right: 0px;
}

</style>



<!-- page script -->
<script>


// ====================================== Variables

var clicked_id_record;      // store the records clicked on the table

var rules                   = ({{rules|tojson|safe}})           // get list of all rules
var toast                   = $.toast;                          // toast object
var record_important_fields = ({{ CASE_FIELDS|tojson|safe }});  // this will used to identify what is the important fields to be displaied on the table


var enable_record_table     = true;                 // if true then the right side artifact record will not be opened on click the tr record
var is_record_tr_clicked    = false                 // store wheither there are a raw in event_table clicked or not
sort_asc_icon_class         = "fa-sort-amount-asc"  // icon of sort asc
sort_desc_icon_class        = "fa-sort-amount-desc" // icon of sort desc
sort_disabled_icon_class    = "fa-unsorted"         // icon of data unsorted
var current_clicked_sort_by = "";                   // field that is being used to sort


// search query
var finished_init_tags        = false; // true if all search query tags input initialization done (used when adding rule tag and machine name, etc.)
var lock_adding_tag           = false; // locker for adding input tags (used to stop adding tag untill previous tag added)
var search_type               = 'tagsinput' // type of search (tagsinput|simple|advance)




// store the current sort by values
var query_sort_by = {
  "name" : "Data.@timestamp", // default sort by
  "order": 0 // 0 = "asc" , 1 = "desc"
}

// Search query input tags controller
var search_query_obj = $('#search_query')


// Advanced search
var fields_mapping  = ({{ fields_mapping|tojson|safe }}); // this will contain all the fields in the index
var query_builder_v = $('#builder') // contain the query builder html (place to select query terms on advanced search)


// datetime picker
var datetime_range_search   = null; // contain the selected value from date range


var search_query            = JSON.parse( decodeHtml('{{search_query}}').split('\\"').join('"') );  // get predefined search query from the request
var search                  = convert_json_to_list(search_query);                                   // convert the predefined search query to json query 
var search_query_tagsinput  = $('#search_query');                                                   // element of the search query input tags



// ====================================== Functions





// this function will resize the record details and content table if window resized
function resizeDiv(){
	var hight = ($(window).height() / 100 ); // 70% of the window size
	$('#record_details').css('height', (hight*74) + 'px');
	$('#content_table').css('height' , (hight*87) + 'px')
}






// get the rule details by its rule name
function get_rule_by_name(rule_name){
  for(var i = 0 ; i<rules.length ; i++){
    if( rules[i]['rule_name'] == rule_name)
        return rules[i]
  }
  return [];
}



// return list of all rule names
function get_rules_names(){
  var rule_names = []
  for(var i = 0 ; i<rules.length ; i++)
    rule_names.push(rules[i]['rule_name'])
  return rule_names
}









// get more details for specifc field
function get_field_mapping(field){
	for(var i = 0 ; i< fields_mapping.length ; i++)
		if(field == fields_mapping[i]['field_path'])
			return fields_mapping[i]
}








// build the advanced query builder
function query_builder_fun() {
    var filters_list = []
    for (var i = 0; i < fields_mapping.length; i++) {
        switch (fields_mapping[i]['type']) {
            case "date":
                filters_list.push({
                    input_event: 'dp.change',
                    id: fields_mapping[i]['field_path'],
                    label: fields_mapping[i]['field_path'],
                    type: 'datetime',
                    size: 40,
                    operators: ['equal', 'not_equal']
                })
                break;
            case "select":
                filters_list.push({
                    id: fields_mapping[i]['field_path'],
                    label: fields_mapping[i]['field_path'],
                    type: 'string',
                    input: 'select',
                    size: 40,
                    operators: ['equal', 'not_equal'],
                    values: fields_mapping[i]['values']
                })
                break;
            default:
                filters_list.push({
                    id: fields_mapping[i]['field_path'],
                    label: fields_mapping[i]['field_path'],
                    type: 'string',
                    size: 40,
                    operators: ['equal', 'not_equal', 'contains', 'not_contains']
                })
                break;
        }
    }

    var options = {
        plugins: ['bt-tooltip-errors'],
        filters: filters_list
    }

    query_builder_v.queryBuilder(options)
    $('.query-builder .rule-filter-container .form-control').select2()
    // make the input field a select2 object (you can search on the fields)
    query_builder_v.on('afterApplyRuleFlags.queryBuilder', function(e, rule) {
        var form = rule.$el.find('.rule-filter-container .form-control')

        if (form.length > 0 && !form.data('select2')) {
            form.select2()
        }

    });

    // fix the datetime value on the query rule
    query_builder_v.on('afterCreateRuleInput.queryBuilder', function(e, rule) {

        if (rule.filter['type'] != "datetime")
            return;

        var query_value_container = rule.$el.find('.rule-value-container .form-control')

        query_value_container.datepicker({
            language: 'en',
            timepicker: true,
            timeFormat: 'hh:ii:00',
            dateFormat: 'yyyy-mm-dd',
            range: true,
            toggleSelected: false,
            multipleDatesSeparator: ",",
            onShow: function(dp, animationCompleted) {
                if (!animationCompleted) {
                    $('.datepicker--content').show();
                    $('.datepicker--time').show();
                }
            },
            onSelect: function(fd, d, picker) {
                if (fd == "" || fd == null)
                    return;
                var is_date_range = (fd.indexOf(',') == -1) ? false : true; // check if it is date or range

                fd = fd.split(' ').join('T').replace(',', ' TO ')
                fd = (is_date_range) ? "[" + fd + "]" : fd;

                query_value_container.val(fd);
                query_value_container.trigger('change') // trigger the querybuilder for the new date update
            }
        });

        query_value_container.data('datepicker')
    });

}









// return the advanced search query json
function get_advanced_search_query(){
	return query_builder_v.queryBuilder('getRules')
}








// get the custom json query from the advanced search
function get_es_json_query(adv_search){
	if(adv_search == null)
		return {};
	var result = {}
	result[ adv_search["condition"] ] = [];

	// for each rule in the query
	for(var i = 0 ; i< adv_search['rules'].length ; i++){
		if( adv_search['rules'][i].hasOwnProperty("rules") ){
			result[ adv_search['condition'] ].push( get_es_json_query( adv_search['rules'][i] ) )
		} else {
			// build the field query name and value (==string:value)
			var f = ""
			switch(adv_search['rules'][i]['operator']){
				case "equal": 		f += "=="; break;
				case "not_equal": 	f += "!="; break;
				case "contains": 	f += "=~"; break;
				case "not_contains":f += "!~"; break;
			}
			f += adv_search['rules'][i]['field']
			var pushed = {}
			pushed[f] = adv_search['rules'][i]['value']

			result[ adv_search['condition'] ].push( pushed )
		}

	}
	return result
}











// this function take the field path, and check what is the icon to use (disabled, asc, or desc)
function get_sort_icon(field){
    if(query_sort_by["name"] != field)
        return sort_disabled_icon_class
    if(query_sort_by["order"] == 0)
        return sort_asc_icon_class
    return sort_desc_icon_class
}










// this used to update the search records and information
function search_button_click(){
	

    // if the search type not simple, then build the elasticsearch query 
    if(search_type != 'simple'){
        search_json     = build_elasticsearch_query_json();
        console.log(search_json)
        // get the elasticsearch query string
        var search_es   = build_search_query(search_json);
    }
    else {
        // if the search type is simple, then take it as is
        var search_es = $("#search_query_simple").val()
    }
    

    change_sample_query_search(search_es);          // change the sample query text
    reload_records(search_es , 0 , query_sort_by ); // request the new results
    //reload_artifacts_list(search_es);
}









// used to update a tag to the search query tags
function update_search_query_input_tag(tag , id, option="contains"){
  if(tag.split('|').length == 1 && lock_adding_tag == false && search_type == 'tagsinput'){
      lock_adding_tag = true; // lock adding new item tags input

      // search for the tag label

      var item = null;
      for(var i = 0 ; i < search_query_tagsinput.val().length ; i++)
          if( search_query_tagsinput.val()[i].split('|')[0] == id )
            item = search_query_tagsinput.val()[i];


      // if not found return false
      if( item == null){
        lock_adding_tag = false; // disable lock adding new item tags input
        return false;
      }

      var new_item = id + "|" + tag + "|" + option; // new item stored on search query tag
      search_query_tagsinput.tagsinput('change_tag' , [ item ,new_item ]);  // trigger change to search query tag input

      lock_adding_tag = false; // disable lock adding new item tags input
      return true;
  } else{ 
      lock_adding_tag = false; // disable lock adding new item tags input
      return false;
  }

}








// used to add a tag to the search query tags
function add_search_query_input_tag(tag , option="contains"){
    if(tag.split('|').length == 1 && lock_adding_tag == false && (search_type == 'tagsinput' || search_type == 'simple' )){
        lock_adding_tag = true; // lock adding new item tags input

        if(search_type == 'tagsinput')
            search_query_tagsinput.tagsinput('add' , search_query_tagsinput.val().length + "|" + tag + "|" + option ); // trigger change to search query tag input
        else if(search_type == 'simple'){
            var old_search_query_simple = $('#search_query_simple').val() 
            console.log(old_search_query_simple)
            var search_json = {"AND" : []}


            var index_of_first_colon  = tag.indexOf(':')
            var col                   = tag.substring(0 , index_of_first_colon);
            var val                   = tag.substring( index_of_first_colon +1 );
            var colmn_name            = (col == "") ? "string" : col;   // if column field not specified
            var column_value          = val;                           
            var v                     = {};

            switch(option){
                case "not_contains" : colmn_name = '!~' + colmn_name; break;
                case "contains"     : colmn_name = '=~' + colmn_name; break;
                case "equal"        : colmn_name = '==' + colmn_name; break;
                case "not_equal"    : colmn_name = '!=' + colmn_name; break;
            }

            v[colmn_name] = column_value;
            search_json["AND"].push( {"string": old_search_query_simple} );
            search_json["AND"].push( v );
            console.log(search_json)

            var search_es   = build_search_query(search_json);
            console.log(search_es)

            $('#search_query_simple').val( search_es )
            change_sample_query_search(search_es)
            search_button_click()
        }

        lock_adding_tag = false; // disable lock adding new item tags input
        return true;
    } else{
        lock_adding_tag = false; // disable lock adding new item tags input
        return false;
    }

}








// change the sample query search html content to the new search query
function change_sample_query_search(search_es){
    sort_es = '<a class="text-yellow fa '+ get_sort_icon(query_sort_by["name"]) + '"></a> ' + query_sort_by["name"];
   	var search_string = search_es
   		.split(' AND ').join(' <span class="text-red">AND</span> ')
   		.split(' OR ').join(' <span class="text-red">OR</span> ')
   		.split('!').join('<span class="text-green">!</span>')

    search_es = ' <a class="text-yellow fa fa-search"></a> <span id="sample_query_search_content">' + search_string + "</span>"
    $('#sample_query_search').html( '<h5>' + sort_es  + search_es + '</h5>');
}











// this will rebuild the paging numbers and total results in the page
function rebuild_paging(wanted_page , total_records){
    
    
      // edit the paging
      $('#total_records').text( total_records );
      var total_pages = Math.floor( total_records / 30 ) + 1;
      $('#number_of_pages').text(total_pages);
      var paging_html = "";
      
      if(wanted_page > 0)
        paging_html = paging_html + '<li class="paginate_button"><a id="'+0+'">« First</a></li>';
      
      for(var p = wanted_page - 10; p < wanted_page + 10 && p < total_pages; p++){
          if(p < 0)
            continue;
          if( p == wanted_page)
              paging_html = paging_html + '<li id="current_page" class="paginate_button disabled"><a  id="'+p+'" class="color-palette">'+(p+1)+'</a></li>';
          else 
              paging_html = paging_html + '<li class="paginate_button" ><a  id="'+p+'">'+(p+1)+'</a></li>';
      }
      if(wanted_page < total_pages -1) 
        paging_html = paging_html + '<li class="paginate_button"><a id="'+(total_pages-1)+'">Last »</a></li>';
      $('#paging').html(paging_html);
}














// this will rebuild the table content of the records when loading the records
function rebuild_records(records){

    var new_tr = '';

    new_tr += "<tr>";
    new_tr +=  "<th style=\"width: 50px\">Op.</th>";

    new_tr +=  '<th style="width: 150px">Time Stamp \
      <a data="Data.@timestamp" class="clickable float_right fa ' + get_sort_icon("Data.@timestamp") + ' clicked_sort" style="margin: 3px;"></a></th>';

    new_tr +=  '<th style="width: 150px">Data Type <a data="data_type" class="clickable float_right fa ' + get_sort_icon("data_type") + ' clicked_sort"></a></th>';
    new_tr +=  '<th style="width: 150px">Machine <a data="machine" class="clickable float_right fa ' + get_sort_icon("machine") + ' clicked_sort"></a></th>';
    new_tr +=  "<th>Details</th>";
    new_tr +=  "</tr>";
    //record_important_fields
    for(var i = 0 ; i < records.length ; i++){
        var timestamp   = records[i]['_source']['Data']['@timestamp']
        var hasTag      = ("tag_id" in records[i]['_source'])
        var tag_id_attr = hasTag ? 'tag_id="'+records[i]['_source']['tag_id']+'"' : "" ;
        
        new_tr += '<tr class="event_record_click" id="'+i+'" data-type="'+records[i]['_source']['data_type']+'">';
        new_tr +='<td>\
            <a><li data-id="'+records[i]['_id']+'" class="go_graph fa fa-code-fork clickable"></li></a>\
            <a data-toggle="modal" data-target="#record_details_dialog" class="record_details_dialog_click" style="cursor: pointer" id="'+i+'"><li class="fa  fa-caret-square-o-right" ></li></a>\
            <a><li '+tag_id_attr+' data="just_tag" data-time="'+timestamp+'" id="'+records[i]['_id']+'" class="'+((hasTag) ? 'text-red' : '' )+' record_tag fa fa-tag clickable"></li></a>\
            </td>';


    
	if( records[i]['_source']['Data']['@timestamp'] != null && records[i]['_source']['Data']['@timestamp'].indexOf('.') != -1)
        	timestamp = timestamp.substring(0 , records[i]['_source']['Data']['@timestamp'].indexOf('.'))

        new_tr +='<td>'+ timestamp.replace('T' , ' ') +' \
              <a  style="cursor: pointer " class="table_timestamp_field_button float_right" data-id="'+i+'" data-toggle="popover" data-original-title="Time range (min.)"><i class="fa fa-search-plus"></i></a>\
            \
                <div id="table_timestamp_field_popover_'+i+'" class=" hide"   data-trigger="focus">\
                    <input type="hidden" class="form-control" value="'+timestamp+'" id="table_timestamp_field_popover_timestamp_'+i+'">\
                    <div class="input-group input-group-sm">\
                        <input type="number" class="form-control" placeholder="min." id="table_timestamp_field_popover_min_'+i+'" width="5" value="0" min="0" step="1">\
                        <span class="input-group-btn">\
                        <button type="button" data-id="'+i+'" class="table_timestamp_field_popover_submit btn btn-primary btn-flat">\
                            <i class="fa fa-arrow-right"></i>\
                        </button>\
                        </span>\
                    </div>\
                </div>\
              \
            </td>';


        new_tr += '<td>'+ records[i]['_source']['data_type'] +' \
                <span class="dropdown float_right">\
                    <a class="fields-dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span class="clickable fa fa-filter "></span></a>\
                    <ul class="dropdown-menu">\
                    <li class="clickable" data="item" id><a id="data_type:'+records[i]['_source']['data_type']+'|equal"        class="clickable add_to_search_query"><i class="fa fa-search-plus"></i> Equals</a></li>\
                    <li class="clickable" data="item" id><a id="data_type:'+records[i]['_source']['data_type']+'|contains"     class="clickable add_to_search_query"><i class="fa fa-search-plus"></i> Contains</a></li>\
                    <li class="clickable" data="item" id><a id="data_type:'+records[i]['_source']['data_type']+'|not_contains" class="clickable add_to_search_query"><i class="fa fa-search-minus"></i> Not Contains</a></li>\
                    <li class="clickable" data="item" id><a id="data_type:'+records[i]['_source']['data_type']+'|not_equal"    class="clickable add_to_search_query"><i class="fa fa-search-minus"></i> Not Equals</a></li>\
                    <li class="clickable" data="item" id><a data="data_type" class="clickable clicked_sort"><i class="fa fa-sort-amount-asc"></i> Sort</a></li>\
                    </ul>\
                </span>\
                </td>';
        

        new_tr += '<td>'+ records[i]['_source']['machinename'] +' \
                <span class="dropdown float_right">\
                    <a class="fields-dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span class="clickable fa fa-filter "></span></a>\
                    <ul class="dropdown-menu">\
                    <li class="clickable" data="item" id><a id="machine:'+records[i]['_source']['machine']+'|equal"        class="clickable add_to_search_query"><i class="fa fa-search-plus"></i> Equals</a></li>\
                    <li class="clickable" data="item" id><a id="machine:'+records[i]['_source']['machine']+'|contains"     class="clickable add_to_search_query"><i class="fa fa-search-plus"></i> Contains</a></li>\
                    <li class="clickable" data="item" id><a id="machine:'+records[i]['_source']['machine']+'|not_contains" class="clickable add_to_search_query"><i class="fa fa-search-minus"></i> Not Contains</a></li>\
                    <li class="clickable" data="item" id><a id="machine:'+records[i]['_source']['machine']+'|not_equal"    class="clickable add_to_search_query"><i class="fa fa-search-minus"></i> Not Equals</a></li>\
                    <li class="clickable" data="item" id><a data="machine" class="clickable clicked_sort"><i class="fa fa-sort-amount-asc"></i> Sort</a></li>\
                    </ul>\
                </span>\
                </td>';

        var date_type = records[i]['_source']['data_type']
        var imp_rec = record_important_fields[date_type];
        var td_details = "";
        if(imp_rec == null){
            imp_rec = [];
            td_details = "Important fields not defined for this data type"
        }

        for(var j = 0 ; j < imp_rec.length; j++){
            var search_field_path = imp_rec[j][1].substring( imp_rec[j][1].indexOf('.') +1  );
            var field_value = get_field_from_json_path(records[i] , imp_rec[j][1]);
            var html_field_options = '<span class="dropdown">\
                <a class="fields-dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span class="clickable bg-light-blue fa fa-filter"></span></a>\
                <ul class="dropdown-menu">\
                <li class="clickable" data="item" id><a id="'+search_field_path+':'+escapeHtml(field_value)+'|equal"        class="clickable add_to_search_query"><i class="fa fa-search-plus"></i> Equals</a></li>\
                <li class="clickable" data="item" id><a id="'+search_field_path+':'+escapeHtml(field_value)+'|contains"     class="clickable add_to_search_query"><i class="fa fa-search-plus"></i> Contains</a></li>\
                <li class="clickable" data="item" id><a id="'+search_field_path+':'+escapeHtml(field_value)+'|not_contains" class="clickable add_to_search_query"><i class="fa fa-search-minus"></i> Not Contains</a></li>\
                <li class="clickable" data="item" id><a id="'+search_field_path+':'+escapeHtml(field_value)+'|not_equal"    class="clickable add_to_search_query"><i class="fa fa-search-minus"></i> Not Equals</a></li>\
                <li class="clickable" data="item" id><a data="'+search_field_path+'" class="clickable clicked_sort"><i class="fa fa-sort-amount-asc"></i> Sort</a></li>\
                </ul>\
              </span>';
            td_details += ' <span class="badge bg-blue"> ' + html_field_options + imp_rec[j][0]+'</span> ' + escapeHtml(field_value);
        }

        new_tr +='<td>'+ td_details + '</td>';
        new_tr +='</tr>';
    }
    $('#table_events tbody').html(new_tr);
    $(".fields-dropdown-toggle").dropdown();


    // on click add tag button
    $('a').on( 'click' , 'li.record_tag' , function(){
        var id          = $(this).attr('id');
        var tag_content = $(this).attr('data');
        var time        = $(this).attr('data-time');
        var tag_id      = $(this).attr('tag_id')
        if(tag_id != undefined){
            // if it has tag, then remove it
            del_tag(id , tag_id , $(this))
        } else {
            // if it does not has tag, then add tag
            add_doc_tag(id , tag_content , time , $(this))
        }
        

    })

    // on click go to graph
    $('a').on( 'click' , 'li.go_graph' , function(){
        var id = $(this).attr('data-id');
        "{% set recordid = '"+id+"' %}"
        var baseURL = "{{url_for('graph_display' , case_id=case_details['casename'] , record_id='recordid')}}".replace('recordid' , id)
        location.href = baseURL;
    })
}








// function used to delete tag from record through ajax
function del_tag(record_id , tag_id , element){

    $.ajax({
        type : 'POST',
        url : "/case/{{case_details['casename']}}/timeline_delete_tag_ajax",
        contentType: 'application/json;charset=UTF-8',
        data : JSON.stringify({'data': {"tag_id":tag_id , 'record_id' : record_id } }),
        success: function(result) {
          var result = JSON.parse(result);
          if(result['result'] == "successful"){
              
              element.removeClass('text-red');
              element.removeAttr('tag_id');

              toast_msg("Deleted tag: ["+tag_id+"]");
          } else{
              toast_msg(result['data']  , type = 'error' , header = 'Error')
          }
            
              
        },  
        error: function(error){
          toast_msg("Connection Failed" , icon = 'error' , heading = 'Error')
        }
    });
}





// function used to add tag to a document through ajax
function add_doc_tag(doc_id , tag_content , timestamp , element){
  $.ajax({
    type : 'POST',
    url : "/case/{{case_details['casename']}}/add_tag_ajax",
    contentType: 'application/json;charset=UTF-8',
    data : JSON.stringify({'data': {"tag":tag_content , 'doc_id' : doc_id , 'time': timestamp } }),
    success: function(result) {
      var result = JSON.parse(result);
      if(result['result'] == "successful"){

          toast_msg("Added tag: ["+tag_content+"] to " + doc_id)
          element.addClass('text-red');
          element.attr('tag_id' , result['tag_id'])
      
      } else{
          toast_msg(result['data'] , type='error' , header='Error')
      }
    },
    error: function(error){
      toast_msg('Connection Failed' , type='error' , header='Error')
    }
  });
}












// encode the unsafe string to html
function escapeHtml(unsafe) {
  if(unsafe != undefined)
      return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
  else
      return unsafe
}















// request records data through ajax
function reload_records(search , wanted_page , sort_by = query_sort_by ){
    
  var search  = (search == "") ? "" : 'AND (' + search+ ')'
  search      = '!(data_type:"tag") ' + search;

  $.ajax({
    type : 'POST',
    url : "/case/{{case_details['casename']}}/browse_artifacts_ajax",
    contentType: 'application/json;charset=UTF-8',
    data : JSON.stringify({'data': {"wanted_page":wanted_page , 'query' : search , 'sort_by' : sort_by } }),
    success: function(result) {


      var r = JSON.parse(result);
      var total_records = parseInt(r['res_total']);
          
      // if there is no index print error message
      if( "res_records" in r && r["res_records"] == "no such index")
          toast_msg("No such index, try process the artifacts" , type='error' , header="Warning")
      else {
          // build paging table
          rebuild_paging(wanted_page , total_records);
          ajax_records = r['res_records']

          // build records table
          rebuild_records(ajax_records);
          
          // build data type drop-down list 
          //console.log(r)
          
          var list = ""
          if(r['res_total'] != 0){
            var aggs = r['aggs']
            for(var i = 0 ; i <aggs.length ; i++)
                list += '<li class="clickable"><a id="data_type:'+aggs[i]['key']+'" class="clickable add_to_search_query">'+aggs[i]['key']+' <span class="badge bg-red">'+aggs[i]['doc_count']+'</span></a></li>'
          }
          $('#artifacts_list').html(list);
          $('.artifacts_list_button').dropdown()
        
          if (is_record_tr_clicked){
                // click the first raw in the table
                $("#table_events tr#0").click()

                //$("html, body").animate({ scrollTop: 0 }, "slow");
                $("#content_table").animate({ scrollTop: 0 }, "slow");
          }
          // if there is no record, print warning message
          if(total_records == 0)
              toast_msg("Empty results" , type='error' , header="Warning")
          
      }
    },
    error: function(error){
      toast_msg("Connection Failed" , type='error' , header="Error")
    }
  });


}












// deocde html encoded string
function decodeHtml(html) {
    var txt = document.createElement("textarea");
    txt.innerHTML = html;
    return txt.value;
}





















// replace function
function replace(string , val1 , val2){
  return string.split(val1).join(val2);
}















// check if string is ISO format date (YYYY-MM-DDTHH:mm:ss)
function validateDate(isoDate) {
    if (isNaN(Date.parse(isoDate))) {
        return false;
    } else {
        if (isoDate.substr(0,10) != (new Date(isoDate)).toISOString().substr(0,10)) {
            return false;
        }
    }
    return true;
}














// take the search query json and build elasticsearch query
function build_search_query(json_query){
  for( var k in json_query){
    var terms = []  // store all terms of search query
    for (var t = 0 ; t < json_query[k].length ; t++){
        var term = json_query[k][t];
        if( Array.isArray( term[ Object.keys(term)[0] ] ) ){
            terms.push( "(" + build_search_query( term ) + ")" )
        } else {


            var key                   = Object.keys(term)[0].substring(2)
            var field_mapping         = get_field_mapping(key)
            var operator              = Object.keys(term)[0].substring(0,2)
            var val                   = term[ Object.keys(term)[0] ];

            var query_string          = "" ; // contain the string
            // fix the special characters
            var is_val_has_spec_chars = false;
            if(field_mapping != undefined && field_mapping['type'] == 'text'){
                // test for the following since elasticsearch use them as special characters:
                // '+' ,'-', '=', '&&', '||', '>', '<', '!', '(', ')', '{', '}', '[', ']', '^', '"', '~', '*', '?', ':', '\\', '/'
                var old_val             = val; // temp store old val
                var special_chars       = [ '\\' , '/' , ':' , '-' , '{' , '}' , '(', ')' , ' ' , '@' ]
                for(var sc = 0 ; sc < special_chars.length; sc++  )
                    val = replace(  val , special_chars[sc] , "\\" + special_chars[sc] )
                
                if(old_val != val ) 
                    is_val_has_spec_chars = true;
            }
            
            // if the key is a rule, then set the rule as the query value
            if(key == 'rule'){
                var rule_var = get_rule_by_name(val)
                if( rule_var.length == 0){
                    toast_msg("Rule ["+val+"] not exists" , type='error' , header='Warning')
                    return "";
                }
                else
                    val = "(" + get_rule_by_name(val)['rule'] + ")"
            }


            
            if(val == 'null')
                val = "*"
            

            // check if the search for a range [], then dont not add the value inside ""
            if ( (operator == "==" || operator == "!=") && !(val.startsWith("[") && val.endsWith("]")) && key != 'rule')
                val = '"' + val + '"'
              
              
            // check if the search for general terms such as string or rule
            if( key == "string" || key == 'rule')
                key = "";
            else
                key = key + ":"

            console.log("key: " + key)
            console.log("val: " + val)
            // build the query string based on the operator
            switch(operator){
                case "==":
                  query_string = key + val;
                  break;
                case "!=":
                  query_string = "!" + key + val;
                  break;
                case "=~":
                  query_string = key + '*'+val+'*';
                  break;
                case "!~":
                  query_string = "!" + key + '*'+val+'*';
                  break;
                default:
                  query_string = val;
                  break;
            }
            console.log("query_string: " + query_string)
            
            terms.push(query_string)
        }
    }
    console.log(terms)
    return terms.join( ' ' + k + ' ' );
  }
  return ""; // if empty there is no results
}












// this function will return the query json format, to be used later to build the elasticsearch query string
function build_elasticsearch_query_json(){

    // if the search type is advance convert it to elasticsearch query
    if(search_type == 'advance'){

        // convert the advanced query builder into the elasticsearch custom json query
        es_j = get_es_json_query( get_advanced_search_query() )
        return es_j;
    }

    // build the query json format
    var search_json = {"AND" : [] };                  // contain the json search query
    var items       = search_query_tagsinput.val();   // list of search tagsinput query items


    for(var i = 0 ; i < items.length ; i++ ){
        var item                  = items[i].split('|');
        var index_of_first_colon  = item[1].indexOf(':')
        var col                   = item[1].substring(0 , index_of_first_colon);
        var val                   = item[1].substring( index_of_first_colon +1 );
        var v                     = {};
        var colmn_name            = (col == "") ? "string" : col;   // if column field not specified
        var column_value          = val;                           

        if(item[2] == "not_contains")
            colmn_name = '!~' + colmn_name;
        else if(item[2] == 'contains')
            colmn_name = '=~' + colmn_name;
        else if(item[2] == 'equal')
            colmn_name = '==' + colmn_name;
        else if(item[2] == 'not_equal')
            colmn_name = '!=' + colmn_name;

        v[colmn_name]   = column_value;

        search_json["AND"].push( v );
    }
    return search_json;
}















// when click the up/down key on keyboard move clicked record up/down
function keydown_record_navegation(event){
    
    
    switch(event.which) {

        case 37: //left
        case 39: // right

            // if the focused element not the body, dont navigate in records
            if(document.activeElement.tagName != "BODY")
                return;
            
            //event.preventDefault();
            if(event.which == 37)
                var wanted_page_a     = parseInt( $("#current_page").prev().find('a').attr('id') )
            else
                var wanted_page_a     = parseInt( $("#current_page").next().find('a').attr('id') )

            if (isNaN( wanted_page_a ))
                return;
            navegate_to_page(wanted_page_a)

            break;



        case 38: // up
        case 40: // down

            // if the focused element not the body, dont navigate in records
            if(document.activeElement.tagName != "BODY")
                return;


            var trs = $('#table_events').find('tr.disabled');
            if(typeof trs.attr('id') == 'undefined')
                return;
            var container = document.getElementById('content_table');
            
            event.preventDefault();

            var tr_id = trs.attr('id')

            
            if(event.which == 38){
                // if up key 
                tr_id--;
                container.scrollBy({top: -25,left: 0,behavior: 'smooth'});
            } else {
                // if down key
                tr_id++;
                container.scrollBy({top: 25,left: 0,behavior: 'smooth'});
            }
            
            
            var next = $('#table_events').find('tr#'+tr_id);
            if(next.length == 0){
                var key = (event.which == 38) ? 37 : 39;
                document.dispatchEvent(new KeyboardEvent('keydown',{'keyCode':key}));
              return;
            }
            
            next.click()
            break;



        default: 
            return; // exit this handler for other keys
    }
}







// function that wil reset the search terms
function reset_search_terms_func(){
	search_query_tagsinput.tagsinput('removeAll');
	query_builder_v.queryBuilder('reset')
    search_type = 'tagsinput';

    if($('#advance_search_dialog_opener_btn').hasClass('btn-success')){
        $('#advance_search_dialog_opener_btn').addClass('btn-primary')
        $('#advance_search_dialog_opener_btn').removeClass('btn-success')
        $('#advance_search_dialog .advanced_search_dialog_close').click() // fadeout the advanced search box
    }
    

    if($('#simple_search_btn').hasClass('btn-success')){
        $('#simple_search_btn').addClass('btn-primary')
        $('#simple_search_btn').removeClass('btn-success')
        $('.bootstrap-tagsinput').show()
        $("#search_query_simple").hide()
    }
    

    // enable the simple search tags
    $('.bootstrap-tagsinput').removeAttr('disabled')
}




// ====================================== Listeners

// this handle the arrow button to display/hide details 
$(document).on('click' , '.details-arrow-toggle' , function(e){
    var arrow = $(this)
    var target = $("#" + arrow.data('target'))
    var is_active = arrow.hasClass('is-active')

    target.slideToggle({
        duration: 200,
        start: function(){
            if(is_active){
                arrow.removeClass("is-active")
                arrow.html('<i class="fa  fa-caret-down"></i>')
            } else {
                arrow.addClass("is-active")
                arrow.html('<i class="fa  fa-caret-up"></i>')
            }
        }
    })
})





$(document).ready(function(){
	resizeDiv(); // resize the record_details and content_table
});


window.onresize = function(event) {
	resizeDiv(); // resize the record_details and content_table
}








// this function will handle the popover dialog when user click save as rule button
$(function () {

  $('#sample_search_confirm_rule').popover({
                 placement   : 'bottom',
                 title       : 'Save search as rule',
                 html        : true,
                 content     : $('#sample_search_confirm_popover').html(),
              })
    
    // set the position of the popover
  $(document).on('click' , '#sample_search_confirm_rule' , function(e){
                  $('.popover').css("left" , "-230px");
                  $('.popover.bottom>.arrow').css('left' , "94%");
              })
   




})

// if item clicked to be added to the search query (using fa-search-plus)
$("#table_events,#dialog_content,#artifacts_list_container,#record_details_block").on('click' , 'a.table_timestamp_field_button' , function(){

   var id = $(this).data("id")
   console.log("id")
   console.log(id)
   $(this).popover({
                 placement   : 'right',
                 title       : 'timestamp',
                 html        : true,
                 content     : $('#table_timestamp_field_popover_' + id).html(),
              })
    
    
    // set the position of the popover
    //$('.popover').css("width" , "90px");
    //$('.popover.right>.arrow').css('border-right-color' , "#393e5a")
  
});

$("#table_events,#dialog_content,#artifacts_list_container,#record_details_block").on('click' , 'button.table_timestamp_field_popover_submit' , function(){
        var id                  = $(this).data("id")
        var min                 = parseInt($('#table_timestamp_field_popover_min_' + id).val())
        var timestamp           = $('#table_timestamp_field_popover_timestamp_' + id).val()
        if(min == 0){
            t = "Data.@timestamp:"+timestamp
        } else {
            if(timestamp.indexOf("Z") == -1)
            timestamp += "Z"
            
            var timestamp_parsed    = new Date(timestamp)

            var start_date          =  new Date(timestamp)
            var end_date            = new Date(timestamp)

            start_date.setMinutes(timestamp_parsed.getMinutes() - min);
            end_date.setMinutes(timestamp_parsed.getMinutes() + min);

            var start_date_str  = start_date.toISOString().replace(".000Z", "")
            var end_date_str    = end_date.toISOString().replace(".000Z", "")

            t = "Data.@timestamp:["+start_date_str+" TO "+end_date_str+"]"
        }
        
        console.log(t)
        add_search_query_input_tag(t , 'equal');
        timestamp_range_search = search_query_tagsinput.val().length - 1;

})



// close the popover if clicked any place else
$(document).on('click', function (e) {
    var $popover, $target = $(e.target);

    //do nothing if there was a click on popover content
    if ($target.hasClass('popover') || $target.closest('.popover').length) {
        return;
    }

    $('#sample_search_confirm_rule[data-toggle="popover"]').each(function () {
        $popover = $(this);

        if (!$popover.is(e.target) &&
            $popover.has(e.target).length === 0 &&
            $('.popover').has(e.target).length === 0)
        {
            $popover.popover('hide');
        } else {
            //fixes issue described above
            $popover.popover('toggle');
        }
    });



    $('.table_timestamp_field_button[data-toggle="popover"]').each(function () {
        $popover = $(this);

        if (!$popover.is(e.target) &&
            $popover.has(e.target).length === 0 &&
            $('.popover').has(e.target).length === 0)
        {
            $popover.popover('hide');
        } else {
            //fixes issue described above
            $popover.popover('toggle');
        }
    });

})









// if save as rule button clicked, add the rule to dmango
$(document).on('click' , '.sample_search_save_as_rule' , function(){
    var query_search_content = $('#sample_query_search h5 #sample_query_search_content').text().trim()

    // check if the rule query is empty
    if(query_search_content == ""){
        toast_msg('Rule is empty' , type='error' , header='Warning')
        return;
    }

    // check if rule name not empty
    var rule_name = $('#sample_search_confirm_popover_rule_name').val()
    if(rule_name == ""){
        toast_msg('Rule name is empty' , type='error' , header='Warning')
        return;
    }

    var rule_severity     = $('#sample_search_confirm_popover_rule_severity').children('option:selected').val();  // get rule rule_severity
    var rule_description  = $('#sample_search_confirm_popover_rule_description').val();                           // get the rule description

    $.ajax({
        type : 'POST',
        url : "/admin/add_rule",
        contentType: 'application/json;charset=UTF-8',

        data : JSON.stringify({'data': {
                "rule":query_search_content ,
                'rule_name' : rule_name ,
                'rule_severity' : rule_severity,
                'rule_description' : rule_description
              } }),
        success: function(result) {
            var result = JSON.parse(result);

            // if failed
            if(result['result'] == "failed")
                toast_msg(result['message'] , type='error' , header='Add rule failed')

            // if success
            else {
                toast_msg(query_search_content , type='info' , header='Rule added')
                $('#sample_search_confirm_rule').popover('hide')
            }


        },
        error: function(error){
            toast_msg('Connection Failed' , type='error' , header='Error')
        }
    });

})









// when user click search, it will send ajax request to recive the result of the search
$('#search_button').click(function(){
    search_button_click();
});







// on click open advanced search button
$('#advance_search_dialog_opener_btn').click(function(){
    reset_search_terms_func()

    search_button_click()

    $('.bootstrap-tagsinput').attr('disabled' , 'disabled')
    $('#advance_search_dialog').fadeIn()
    if($('#advance_search_dialog').is(":visible")){
        $(this).removeClass('btn-info')
        $(this).addClass('btn-success')
    } else {
        $(this).removeClass('btn-success')
        $(this).addClass('btn-info')
    }
})


// on click the simple search query button 
$('#simple_search_btn').click(function(){
    
    
    
    if($(this).hasClass('btn-primary')){
        var sample_query_search_content = $('#sample_query_search_content').text()
        // enable simple search
        reset_search_terms_func()

        $(this).removeClass('btn-primary')
        $(this).addClass('btn-success')
        $("#search_query_simple").show()
        $("#search_query_simple").val(sample_query_search_content)
        $('.bootstrap-tagsinput').hide()
        search_type = 'simple'
        $('.bootstrap-tagsinput').attr('disabled' , 'disabled')
        
        search_button_click()

    }
})


// if the key Enter pressed, then trigger search button
$("#search_query_simple").keypress(function(event){
    // when entering the Enter key then trigger the search
    if(event.which == 13 ){
        search_button_click()                               // update the search 
    }
})


// if reset search terms clicked, remove all searches from advanced search and simple search (input tags)
$("#reset_search_terms").on('click' , function(){
    reset_search_terms_func()

    search_button_click()
})









// if Close button on advanced search clicked, hide advanced search
$('#advance_search_dialog').on('click' , '.advanced_search_dialog_close' , function(){
    $('#advance_search_dialog').fadeOut()
})








// if Apply button on advanced search clicked
$('#advance_search_dialog').on( 'click' , '.advanced_search_dialog_apply' , function(){
  	var advanced_search_query = get_advanced_search_query()
  	if(advanced_search_query == null){
  		toast_msg("Empty advanced search query" , type='error' , header="Error")
  		return;
  	}

  	search_type = 'advance'; // enable adv search


    // change the color of advance_search_dialog_opener_btn button
    $('#advance_search_dialog_opener_btn').removeClass('btn-info')
    $('#advance_search_dialog_opener_btn').addClass('btn-success')


    // enable the simple search tags
    $('.bootstrap-tagsinput').attr('disabled' , 'disabled')


    search_button_click() // apply the search query
})














// on click enable/disable record details button
$('#disable_enable_details_table').click(function(){
    if($(this).hasClass('text-red')){
        enable_record_table = true;
        $(this).removeClass('text-red')
    } else{
        enable_record_table = false;
        $(this).addClass('text-red')
    }

})




// when a tag input modified, it will trigger this action to submit the modified data
$('#search_query').on('TagInputEdit' , function( event ){
search_button_click();

});





// control the actions on query search controller (dropdown, actions, change item status)
$('#search_query').on('tagOptions' , function( event ){
    var item          = event.item;
    var html_item     = event.html_item;
    var dropdown_menu = html_item.find('.dropdown-menu');


    var menu_actions = '\
            <li class="tagOptions_action_equal_clicked" data="item"><a><span class="fa fa-search-plus" href="#"></span> Equals</a></li>\
    		<li class="tagOptions_action_contains_clicked" data="item"><a><span class="fa fa-search-plus" href="#"></span> Contains</a></li>\
            <li class="tagOptions_action_not_contains_clicked" data="item"><a><span class="fa fa-search-minus" href="#"></span> Not Contains</a></li>\
            <li class="tagOptions_action_not_equal_clicked" data="item"><a><span class="fa fa-search-minus" href="#"></span> Not Equal</a></li>';
    dropdown_menu.html(menu_actions);
    dropdown_menu.dropdown('toggle');

    if(typeof dropdown_menu.attr('data') === 'undefined'){ // this check to avoid define the clicking functions multiple times
        

        // action "equals"
        dropdown_menu.on('click' , 'li.tagOptions_action_equal_clicked' , function(){

            // change the item content to <item_id>|<item_content>|exceludes
            var item          = html_item.data('item')
            var item_parts    = item.split('|');
            var new_item      = item_parts[0] + "|" + item_parts[1] + "|equal";
            search_query_tagsinput.tagsinput('change_tag' , [ item ,new_item ]);  // change the value of the tag
            search_button_click();
        });


        // action "not_equals"
        dropdown_menu.on('click' , 'li.tagOptions_action_not_equal_clicked' , function(){

            // change the item content to <item_id>|<item_content>|exceludes
            var item          = html_item.data('item')
            var item_parts    = item.split('|');
            var new_item      = item_parts[0] + "|" + item_parts[1] + "|not_equal";
            search_query_tagsinput.tagsinput('change_tag' , [ item ,new_item ]);  // change the value of the tag
            search_button_click();
        });

        // action "not_contains"
        dropdown_menu.on('click' , 'li.tagOptions_action_not_contains_clicked' , function(){
            // change the item content to <item_id>|<item_content>|exceludes

            var item        = html_item.data('item')
            var item_parts  = item.split('|');
            var new_item    = item_parts[0] + "|" + item_parts[1] + "|not_contains";
            search_query_tagsinput.tagsinput('change_tag' , [ item ,new_item ]);  // change the value of the tag
            search_button_click();
        });

        // action "contains"
        dropdown_menu.on('click' , 'li.tagOptions_action_contains_clicked' , function(){

            // change the item content to <item_id>|<item_content>|exceludes
            var item          = html_item.data('item')
            var item_parts    = item.split('|');
            var new_item      = item_parts[0] + "|" + item_parts[1] + "|contains";
            search_query_tagsinput.tagsinput('change_tag' , [ item ,new_item ]);  // change the value of the tag
            search_button_click();
        });

        dropdown_menu.attr({'data':'true'});
    }


});








// if an item removed from query search controller refresh the results
$('#search_query').on('itemRemoved ' , function(event){
    $('#search_button').click();
});







// if an item added to query search controller refresh the results
$('#search_query').on('itemAdded' , function(event){
      if(finished_init_tags){
        $('#search_button').click();
      }
});








// before item added to search query controller, check if adding tag locked or not
$('#search_query').on('beforeItemAdd' , function(event){
    var tag = event.item;
    if(lock_adding_tag == false ){
        add_search_query_input_tag(tag)
        event.cancel = true;
    }
});









// if item clicked to be added to the search query (using fa-search-plus)
$("#table_events,#dialog_content,#artifacts_list_container,#record_details_block").on('click' , 'a.add_to_search_query' , function(){

    var item = $(this).attr('id');
    // if action is exceludes
    if(item.endsWith('|not_contains'))
      var re = add_search_query_input_tag(item.split('|')[0] , 'not_contains');
    
    // if specified action is not equals
    else if(item.endsWith('|not_equal'))
        var re = add_search_query_input_tag(item.split('|')[0] , 'not_equal');  
    
    // if specified action is contains
    else if(item.endsWith('|contains'))
        var re = add_search_query_input_tag(item.split('|')[0] , 'contains');   

    // default action is equal
    else
      var re = add_search_query_input_tag(item.split('|')[0] , 'equal');

    

});









// if clicked sort by button on records
$('#table_events').on('click' , '.clicked_sort' , function(){
    if(current_clicked_sort_by != ""){
        current_clicked_sort_by.removeClass(sort_asc_icon_class)
        current_clicked_sort_by.removeClass(sort_desc_icon_class)
        current_clicked_sort_by.addClass(sort_disabled_icon_class)
    }
    current_clicked_sort_by = $(this)
    var sort_by_name = $(this).attr('data')
    if( query_sort_by["name"] == sort_by_name){

        switch(query_sort_by["order"]){
          // sort asc
          case 1:
              $(this).removeClass(sort_desc_icon_class)
              $(this).addClass(sort_asc_icon_class)
              query_sort_by["order"] =0
              break;
          
          // sort desc
          case 0:
              $(this).removeClass(sort_asc_icon_class)
              $(this).addClass(sort_desc_icon_class)
              query_sort_by["order"] =1
              break;
        }

    } else {
        query_sort_by["name"] = sort_by_name;
        query_sort_by["order"] = 0;
        $(this).removeClass(sort_disabled_icon_class)
        $(this).addClass(sort_asc_icon_class)

    }
    $('#search_button').click();  // apply search 
})








function navegate_to_page(page){
    // if the search type not simple, then build the elasticsearch query 
    if(search_type != 'simple'){
        var search_json = build_elasticsearch_query_json();
        
        // get the elasticsearch query string
        var search_es   = build_search_query(search_json);
    }
    else {
        // if the search type is simple, then take it as is
        var search_es = $("#search_query_simple").val()
    }
    
    
    reload_records(search_es , page , query_sort_by); // request the new page

}




// when user click a page number, it will send ajax request and reloads the new records for that page
$("#paging").on('click' , "li a" , function(){
    wanted_page     = parseInt($(this).attr('id'));
    
    navegate_to_page(wanted_page)
});










// on the record clicked, open the right side bar with its information
$("#table_events").on('click' , 'tr.event_record_click' , function(){

      $('#' + clicked_id_record).removeClass('table_events_clicked_tr disabled');
      $('#' + clicked_id_record).css('background-color' ,  '');
      var clicked_id    = $(this).attr('id');
      clicked_id_record = clicked_id;
      $(this).addClass('table_events_clicked_tr disabled');
      $(this).css('background-color' ,  '#636777');

      // change records cliced status to clicked
      is_record_tr_clicked = true


      // if opening the details record disabled dont show it
      if(enable_record_table == false)
          return;


      // build the right side window depends on the data type
      var data_type = $(this).attr('data-type')
      if( data_type == "windows_events" || data_type == "Events" )
        var html = build_windows_event_table(ajax_records[clicked_id] , $('#record_details'));     
      else
        var html = build_simple_artifacts_table(ajax_records[clicked_id] , $('#record_details'));  
      

      //$('#record_details').html(html);
      $('#record_details_block').slideDown();
      $('#content_table').addClass('col-md-8');
});









// on click remove_record_details_block to close the record details window
$('#record_details_block').on('click' , '#remove_record_details_block' , function(){
	$('#record_details_block').slideUp('fast' , function(){
		$('#content_table').removeClass('col-md-8');
	});
})









// open dialog for more details for clicked event
$("#table_events").on('click' , 'tr td a.record_details_dialog_click' , function(){
    record_id   = $(this).attr('id');
    record      = ajax_records[record_id];
    results     = convert_json_to_list(record['_source']);

    var html    = '<tbody>';
    html        += '<tr><th>Field Name</th><th>Value</th></tr>';
    for(var i = 0 ; i < results.length ; i++ ){
        var failed    = results[i][0].split('|').join('.');
        var value     = results[i][1];
        html          += '<tr><td>'+failed+' <a id="'+failed+':'+value+'" class="clickable add_to_search_query float_right"><i class="fa fa-search-plus"></i></a> </td><td>'+value+'</td></tr>';
    }
    html += '</tbody>';
    $('#dialog_content').html(html);
});





// ====================================== Main code



// initialize the tagsinput (search tags)
search_query_obj.tagsinput({
    tagClass: function(item){
        var type = item.split('|')[2];
        if(type == "contains")
            return "btn label label-primary";
        else if(type == "not_contains")
            return "btn label label-warning";
        else if(type == "equal")
            return "btn label label-success";
        else if(type == "not_equal")
            return "btn label label-danger";
    },
    allowDuplicates: true,
    confirmKeys: [13, 44],
    itemText : function(item){
        var i = item.split('|')[1];
        return i;
    },

});





// initialize the fields mapping (used on advanced search)
// string field contain general search terms without fields
fields_mapping.push({
  'field_path': "string",
  'fields': "",
  'type': "text"
})
// add rule name in the fields mapping
fields_mapping.push({
  'field_path': "rule",
  'fields': "",
  'type': "select",
  "values" : get_rules_names()
})


$(document).ready(function(){
    // call the advanced search query builder function
    query_builder_fun()
})









// initialize the datepicker object
$('#query_pick_date_range').datepicker({
      language: 'en',
      timepicker: true,
      timeFormat: 'hh:ii:00',
      dateFormat: 'yyyy-mm-dd',
      range: true,
      toggleSelected: false,
      multipleDatesSeparator:",",
      onSelect: function (fd, d, picker) {
        if( fd == "" || fd == null)
          return;
        datetime_range_search = fd;
      },
      onShow: function(dp, animationCompleted){
            if (!animationCompleted) {

              if (dp.$datepicker.find('button').html()===undefined) { 
                  dp.$datepicker.append('<button type="button" class="btn btn-block btn-warning"><i class="fa fa-check"></i> Done</button>');
                  dp.$datepicker.find('button').click(function(event) {
                     dp.hide();
                  });
               }
                $('.datepicker--content').show();
                $('.datepicker--time').show();
            }
      },
      onHide: function(dp, animationCompleted){
           if (!animationCompleted) {
              if(datetime_range_search == null)
                return;

              var fd = datetime_range_search;
              var is_date_range = ( fd.indexOf(',') == -1) ? false : true ; // check if it is date or range

              fd = fd.split(' ').join('T').replace(',' ,' TO ')

              if(is_date_range)
              	var t = "Data.@timestamp:[" + fd + "]"
              else
              	var t = "Data.@timestamp:" + fd
              
              add_search_query_input_tag(t , 'equal');
              timestamp_range_search = search_query_tagsinput.val().length - 1;

              $('#query_pick_date_range').val('')
           }
      }
  })





$('#query_pick_date_range').data('datepicker')
$('.datepicker--content').show();
$('.datepicker--time').show();









$(document).ready(function(){

    // from the predefined search query add the terms to search query controller
    for(var i = 0 ; i < search.length ; i++){
        var c = search[i][0].split('|');
        var item = c.slice( 1, c.length).join('.') + ":" + search[i][1];
        add_search_query_input_tag(item , "equal");
    }
    finished_init_tags = true;      // set the inii tags as done
    $('#search_button').click();    // apply the predefined search query

})


// enable the top-down press button
$(document).on('keydown' , function(e) {
    keydown_record_navegation(e)
});








</script>



{% endblock %}
